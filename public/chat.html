<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIMNASA Chat</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: #e5ddd5; display: flex; flex-direction: column; height: 100vh; }
        header { background: #075e54; color: white; padding: 10px; display: flex; align-items: center; justify-content: space-between; }
        #status-area { background: white; padding: 10px; display: flex; overflow-x: auto; border-bottom: 1px solid #ddd; }
        .status-circle { width: 50px; height: 50px; border-radius: 50%; border: 2px solid #25d366; margin-right: 10px; flex-shrink: 0; object-fit: cover; }
        #chat-window { flex-grow: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; }
        .msg { max-width: 80%; padding: 8px 12px; border-radius: 10px; margin-bottom: 8px; font-size: 14px; position: relative; }
        .my-msg { align-self: flex-end; background: #dcf8c6; }
        .other-msg { align-self: flex-start; background: white; }
        #input-bar { background: #f0f0f0; padding: 10px; display: flex; align-items: center; }
        input[type="text"] { flex-grow: 1; padding: 10px; border-radius: 20px; border: none; outline: none; }
        .btn { background: none; border: none; font-size: 20px; cursor: pointer; margin: 0 5px; }
    </style>
</head>
<body>

<header>
    <div style="display:flex; align-items:center;">
        <img id="user-icon" src="" style="width:40px; height:40px; border-radius:50%; margin-right:10px;">
        <span id="user-phone">Pakia...</span>
    </div>
    <form action="/upload-status" method="POST" enctype="multipart/form-data">
        <label style="cursor:pointer;">ðŸ“¸<input type="file" name="statusImage" onchange="this.form.submit()" style="display:none"></label>
    </form>
</header>

<div id="status-area"></div>

<div id="chat-window"></div>
<div id="typing-ui" style="padding:5px; font-size:12px; color:gray;"></div>

<div id="input-bar">
    <label style="cursor:pointer;">ðŸ“Ž<input type="file" id="file-input" style="display:none"></label>
    <input type="text" id="msg-input" placeholder="Andika meseji...">
    <button class="btn" id="voice-btn">ðŸŽ¤</button>
    <button class="btn" id="send-btn" style="color:#075e54">âž¤</button>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    let myUser = {};

    // 1. Get Current User & Status
    fetch('/current-user').then(r => r.json()).then(u => {
        myUser = u;
        document.getElementById('user-phone').textContent = u.phone;
        document.getElementById('user-icon').src = u.profileIcon;
    });

    fetch('/get-status').then(r => r.json()).then(data => {
        data.forEach(s => {
            const img = document.createElement('img');
            img.src = s.imageUrl;
            img.className = 'status-circle';
            document.getElementById('status-area').appendChild(img);
        });
    });

    // 2. Chat Logic
    const sendMsg = (payload) => socket.emit('group message', { ...payload, user: myUser.phone, icon: myUser.profileIcon });

    document.getElementById('send-btn').onclick = () => {
        const text = document.getElementById('msg-input').value;
        if(text) {
            sendMsg({ type: 'text', text });
            document.getElementById('msg-input').value = '';
        }
    };

    // 3. File Upload (Picha)
    document.getElementById('file-input').onchange = async (e) => {
        const formData = new FormData();
        formData.append('file', e.target.files[0]);
        const res = await fetch('/api/upload', { method: 'POST', body: formData }).then(r => r.json());
        sendMsg({ type: 'image', url: res.url });
    };

    // 4. Voice Recorder
    let recorder;
    document.getElementById('voice-btn').onclick = async () => {
        if (!recorder) {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            recorder = new MediaRecorder(stream);
            let chunks = [];
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = async () => {
                const blob = new Blob(chunks, { type: 'audio/mp3' });
                const formData = new FormData();
                formData.append('file', blob, 'voice.mp3');
                const res = await fetch('/api/upload', { method: 'POST', body: formData }).then(r => r.json());
                sendMsg({ type: 'voice', url: res.url });
                chunks = [];
            };
            recorder.start();
            document.getElementById('voice-btn').style.color = 'red';
        } else {
            recorder.stop();
            recorder = null;
            document.getElementById('voice-btn').style.color = 'black';
        }
    };

    // 5. Receive Message
    socket.on('group message', (data) => {
        const div = document.createElement('div');
        div.className = `msg ${data.user === myUser.phone ? 'my-msg' : 'other-msg'}`;
        
        let html = `<strong>${data.user}</strong><br>`;
        if(data.type === 'text') html += `<span>${data.text}</span>`;
        if(data.type === 'image') html += `<img src="${data.url}" style="width:100%; border-radius:5px;">`;
        if(data.type === 'voice') html += `<audio src="${data.url}" controls style="width:200px;"></audio>`;
        
        div.innerHTML = html;
        document.getElementById('chat-window').appendChild(div);
        document.getElementById('chat-window').scrollTop = document.getElementById('chat-window').scrollHeight;
    });

    // Typing
    document.getElementById('msg-input').oninput = () => socket.emit('typing', { user: myUser.phone });
    socket.on('typing', (data) => {
        document.getElementById('typing-ui').textContent = `${data.user} anaandika...`;
        setTimeout(() => document.getElementById('typing-ui').textContent = '', 2000);
    });
</script>
</body>
</html>
